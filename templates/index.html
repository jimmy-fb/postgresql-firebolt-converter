<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL to Firebolt Converter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8fafc;
            color: #1a202c;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .setup-section, .converter-section, .test-section, .connection-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .secondary-btn {
            background: #6b7280;
        }
        
        .danger-btn {
            background: #ef4444;
        }
        
        .success-btn {
            background: #10b981;
        }
        
        textarea {
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .result-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .connection-list {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .connection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .connection-item:last-child {
            border-bottom: none;
        }
        
        .test-result {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .attempt-info {
            background: white;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 10px 0;
        }
        
        .attempt-success {
            border-left-color: #10b981;
        }
        
        .attempt-failed {
            border-left-color: #ef4444;
        }
        
        pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 PostgreSQL to Firebolt Converter</h1>
            <p>Convert PostgreSQL queries to Firebolt syntax with AI-powered error correction</p>
        </div>

        <!-- Connection Management Section -->
        <div class="connection-section">
            <h2>💾 Connection Management</h2>
            
            <div class="grid">
                <div>
                    <label for="connectionName">Save Current Connection:</label>
                    <input type="text" id="connectionName" placeholder="Enter connection name">
                    <button onclick="saveConnection()">💾 Save Connection</button>
                </div>
                
                <div>
                    <label for="savedConnections">Load Saved Connection:</label>
                    <select id="savedConnections">
                        <option value="">Select a saved connection...</option>
                    </select>
                    <button onclick="loadConnection()">🔌 Load Connection</button>
                    <button onclick="refreshConnections()" class="secondary-btn">🔄 Refresh</button>
                </div>
            </div>
            
            <div id="connectionList" class="connection-list" style="display: none;">
                <h4>Saved Connections:</h4>
                <div id="connectionItems"></div>
            </div>
        </div>

        <!-- Setup Section -->
        <div class="setup-section">
            <h2>🔧 Firebolt Connection Setup</h2>
            <div class="grid">
                <div class="form-group">
                    <label for="clientId">Client ID:</label>
                    <input type="text" id="clientId" placeholder="Your Firebolt client ID">
                </div>
                
                <div class="form-group">
                    <label for="clientSecret">Client Secret:</label>
                    <input type="password" id="clientSecret" placeholder="Your Firebolt client secret">
                </div>
                
                <div class="form-group">
                    <label for="account">Account:</label>
                    <input type="text" id="account" placeholder="Your Firebolt account name">
                </div>
                
                <div class="form-group">
                    <label for="database">Database:</label>
                    <input type="text" id="database" placeholder="Database name">
                </div>
                
                <div class="form-group">
                    <label for="engine">Engine (Optional):</label>
                    <input type="text" id="engine" placeholder="Engine name (leave empty for system engine)">
                </div>
            </div>
            
            <button onclick="setupConnection()">🚀 Connect to Firebolt</button>
            <div id="connectionStatus"></div>
        </div>

        <!-- Query Converter Section -->
        <div class="converter-section">
            <h2>🔄 Query Converter</h2>
            
            <div class="form-group">
                <label for="postgresqlQuery">PostgreSQL Query:</label>
                <textarea id="postgresqlQuery" placeholder="Paste your PostgreSQL query here...">select sa.applicationid as LAF,
sum(saf.totalfeeamount::decimal) filter (where sfm.feedesc = 'Login Fees')::text as IMD,
sum(saf.totalfeeamount::decimal) filter (where sfm.feedesc = 'Insurance Penetration Percentage')::text as Total_Insurance,
sum(saf.totalfeeamount::decimal) filter (where sfm.feedesc = 'Processing Fees')::text as Processing_Fees,
'skaleup' as source,
now() at TIME ZONE 'Asia/Kolkata' as edl_job_run

--saf.feetypecode,sfm.feedesc,saf.totalfeeamount
from 
skaleup_application sa 
left join skaleup_application_fee saf on sa.applicationkey = saf.applicationkey and saf.isactive = TRUE
left join skaleup_fee_master sfm on saf.feetypecode = sfm.feecode and sfm.isactive = true
where sa.isactive = true 
group by sa.applicationid
order by sa.applicationid</textarea>
            </div>
            
            <button onclick="convertQuery()">🔄 Convert to Firebolt</button>
            
            <div id="conversionResult" class="result-container" style="display: none;">
                <h3>Converted Firebolt Query:</h3>
                <pre id="convertedQuery"></pre>
                
                <h4>Conversion Details:</h4>
                <div id="conversionDetails"></div>
            </div>
        </div>

        <!-- Live Testing Section -->
        <div class="test-section">
            <h2>🧪 Live Testing & Auto-Correction</h2>
            <p>Test your PostgreSQL query against live Firebolt with automatic error correction</p>
            
            <button onclick="testAndFix()">🧪 Test & Auto-Fix Query</button>
            
            <div id="testResults" class="result-container" style="display: none;">
                <h3>Test Results:</h3>
                <div id="testDetails"></div>
            </div>
        </div>
    </div>

    <script>
        let connectionStatus = 'disconnected';
        
        // Connection Management Functions
        async function saveConnection() {
            const name = document.getElementById('connectionName').value.trim();
            if (!name) {
                alert('Please enter a connection name');
                return;
            }
            
            if (connectionStatus !== 'connected') {
                alert('No active connection to save');
                return;
            }
            
            try {
                const response = await fetch('/api/save-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message);
                    document.getElementById('connectionName').value = '';
                    refreshConnections();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving connection: ' + error.message);
            }
        }
        
        async function loadConnection() {
            const name = document.getElementById('savedConnections').value;
            if (!name) {
                alert('Please select a connection to load');
                return;
            }
            
            try {
                const response = await fetch('/api/load-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    connectionStatus = 'connected';
                    showStatus('connectionStatus', result.message, 'success');
                    alert('Connection loaded successfully!');
                } else {
                    showStatus('connectionStatus', result.error || result.message, 'error');
                }
            } catch (error) {
                showStatus('connectionStatus', 'Error loading connection: ' + error.message, 'error');
            }
        }
        
        async function refreshConnections() {
            try {
                const response = await fetch('/api/list-connections');
                const result = await response.json();
                
                const select = document.getElementById('savedConnections');
                select.innerHTML = '<option value="">Select a saved connection...</option>';
                
                if (result.success && result.connections.length > 0) {
                    result.connections.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                    
                    // Show connection list
                    const listDiv = document.getElementById('connectionList');
                    const itemsDiv = document.getElementById('connectionItems');
                    itemsDiv.innerHTML = '';
                    
                    result.connections.forEach(name => {
                        const item = document.createElement('div');
                        item.className = 'connection-item';
                        item.innerHTML = `
                            <span>${name}</span>
                            <button onclick="loadSpecificConnection('${name}')" class="success-btn">Load</button>
                        `;
                        itemsDiv.appendChild(item);
                    });
                    
                    listDiv.style.display = 'block';
                } else {
                    document.getElementById('connectionList').style.display = 'none';
                }
            } catch (error) {
                console.error('Error refreshing connections:', error);
            }
        }
        
        async function loadSpecificConnection(name) {
            document.getElementById('savedConnections').value = name;
            await loadConnection();
        }
        
        // Setup connection
        async function setupConnection() {
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;
            const account = document.getElementById('account').value;
            const database = document.getElementById('database').value;
            const engine = document.getElementById('engine').value;
            
            if (!clientId || !clientSecret || !account || !database) {
                alert('Please fill in all required fields (Client ID, Client Secret, Account, Database)');
                return;
            }
            
            showStatus('connectionStatus', '🔄 Connecting to Firebolt...', 'info');
            
            try {
                const response = await fetch('/api/setup-firebolt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: clientId,
                        client_secret: clientSecret,
                        account: account,
                        database: database,
                        engine: engine || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    connectionStatus = 'connected';
                    showStatus('connectionStatus', '✅ ' + result.message, 'success');
                } else {
                    connectionStatus = 'disconnected';
                    showStatus('connectionStatus', '❌ ' + (result.error || result.message), 'error');
                }
            } catch (error) {
                connectionStatus = 'disconnected';
                showStatus('connectionStatus', '❌ Connection failed: ' + error.message, 'error');
            }
        }
        
        // Convert query
        async function convertQuery() {
            const query = document.getElementById('postgresqlQuery').value.trim();
            
            if (!query) {
                alert('Please enter a PostgreSQL query');
                return;
            }
            
            try {
                const response = await fetch('/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postgresql_query: query })
                });
                
                const result = await response.json();
                
                document.getElementById('conversionResult').style.display = 'block';
                document.getElementById('convertedQuery').textContent = result.converted_sql;
                
                let detailsHTML = '';
                if (result.method_used) {
                    detailsHTML += `<p><strong>Method:</strong> ${result.method_used}</p>`;
                }
                if (result.warnings && result.warnings.length > 0) {
                    detailsHTML += '<p><strong>Warnings:</strong></p><ul>';
                    result.warnings.forEach(warning => {
                        detailsHTML += `<li>${warning}</li>`;
                    });
                    detailsHTML += '</ul>';
                }
                
                document.getElementById('conversionDetails').innerHTML = detailsHTML;
                
            } catch (error) {
                alert('Error converting query: ' + error.message);
            }
        }
        
        // Test and fix query
        async function testAndFix() {
            const query = document.getElementById('postgresqlQuery').value.trim();
            
            if (!query) {
                alert('Please enter a PostgreSQL query');
                return;
            }
            
            if (connectionStatus !== 'connected') {
                alert('Please establish Firebolt connection first');
                return;
            }
            
            const testResults = document.getElementById('testResults');
            const testDetails = document.getElementById('testDetails');
            
            testResults.style.display = 'block';
            testDetails.innerHTML = '<div class="loading">🔄</div> Testing and fixing query...';
            
            try {
                const response = await fetch('/api/test-and-fix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ postgresql_query: query })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayTestResults(result.result);
                } else {
                    testDetails.innerHTML = `<div class="status error">❌ ${result.error}</div>`;
                }
                
            } catch (error) {
                testDetails.innerHTML = `<div class="status error">❌ Error: ${error.message}</div>`;
            }
        }
        
        function displayTestResults(result) {
            const testDetails = document.getElementById('testDetails');
            let html = '';
            
            // Overall status
            if (result.final_status === 'success') {
                html += `<div class="status success">✅ Query successfully executed after ${result.total_attempts} attempt(s)</div>`;
            } else {
                html += `<div class="status error">❌ Query failed after ${result.total_attempts} attempts</div>`;
            }
            
            // Show each attempt
            if (result.attempts && result.attempts.length > 0) {
                html += '<h4>Attempt Details:</h4>';
                
                result.attempts.forEach((attempt, index) => {
                    const isSuccess = attempt.success;
                    const className = isSuccess ? 'attempt-success' : 'attempt-failed';
                    
                    html += `<div class="attempt-info ${className}">`;
                    html += `<h5>Attempt ${attempt.attempt} ${isSuccess ? '✅' : '❌'}</h5>`;
                    
                    if (attempt.converted_query) {
                        html += '<p><strong>Query:</strong></p>';
                        html += `<pre>${attempt.converted_query}</pre>`;
                    }
                    
                    if (isSuccess && attempt.result) {
                        html += `<p><strong>✅ Success!</strong> Query returned ${attempt.result.rows_affected || 0} rows</p>`;
                        if (attempt.result.data && attempt.result.data.length > 0) {
                            html += '<p><strong>Sample Data (first 3 rows):</strong></p>';
                            html += '<pre>' + JSON.stringify(attempt.result.data.slice(0, 3), null, 2) + '</pre>';
                        }
                    } else if (attempt.error) {
                        html += `<p><strong>❌ Error:</strong> ${attempt.error}</p>`;
                        
                        if (attempt.suggested_correction) {
                            html += '<p><strong>🔧 Attempted Correction:</strong></p>';
                            html += `<pre>${attempt.suggested_correction}</pre>`;
                        }
                        
                        if (attempt.rule_based_fix) {
                            html += '<p><strong>🛠️ Rule-based Fix Applied:</strong></p>';
                            html += `<pre>${attempt.rule_based_fix}</pre>`;
                        }
                    }
                    
                    html += '</div>';
                });
            }
            
            // Show final result or suggestions
            if (result.final_status === 'success' && result.final_result) {
                html += '<h4>Final Result:</h4>';
                html += `<p>✅ Successfully executed with ${result.final_result.rows_affected || 0} rows affected</p>`;
                html += '<p><strong>Final Query:</strong></p>';
                html += `<pre>${result.final_query}</pre>`;
            } else if (result.suggestions) {
                html += '<h4>💡 Manual Fix Suggestions:</h4>';
                html += '<ul>';
                result.suggestions.forEach(suggestion => {
                    html += `<li>${suggestion}</li>`;
                });
                html += '</ul>';
            }
            
            testDetails.innerHTML = html;
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        // Load saved connections on page load
        document.addEventListener('DOMContentLoaded', refreshConnections);
    </script>
</body>
</html> 